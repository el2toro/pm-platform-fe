trigger:
- master

stages:
# -----------------------------
# Stage 1: Build Angular App
# -----------------------------
- stage: Build
  displayName: Build Angular App
  jobs:
    - job: Build
      pool:
        name: 'Self-Hosted'
      steps:
        # 1️⃣ Navigate into your Angular project and build
        - script: |
            cd pm-platform-fe
            npm ci
            npx ng build --configuration production
          displayName: 'Build Angular App'

        # 2️⃣ Verify dist folder exists
        - script: dir pm-platform-fe\dist
          displayName: 'Verify dist folder'

        # 3️⃣ Publish pipeline artifact (multi-stage friendly)
        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: 'pm-platform-fe/dist/pm-platform-fe'
            artifact: 'angular-build'
            publishLocation: 'pipeline'
          displayName: 'Publish Angular Build Artifact'

# -----------------------------
# Stage 2: Deploy to Azure Web App
# -----------------------------
- stage: Deploy
  displayName: Deploy Angular to Azure
  dependsOn: Build
  jobs:
    - job: Deploy
      pool:
        name: 'Self-Hosted'
      steps:
        # 1️⃣ Download artifact
        - task: DownloadPipelineArtifact@2
          inputs:
            artifact: 'angular-build'
            path: '$(Pipeline.Workspace)/angular-build'
          displayName: 'Download Angular Build Artifact'

        # 2️⃣ Deploy to Azure Web App
        - task: AzureWebApp@1
          inputs:
            azureSubscription: 'resourceManagerServiceConnection'
            appName: 'pmplatform'
            package: '$(Pipeline.Workspace)/angular-build'
          displayName: 'Deploy Angular App to Azure Web App'
