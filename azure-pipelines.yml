trigger:
- master

stages:   # top-level keyword
  - stage: Build
    displayName: Build Angular
    jobs:
      - job: Build
        pool:
          name: 'Self-Hosted'
        steps:
          - script: |
              cd pm-platform-fe
              npm install
              npx ng build --configuration production
            displayName: 'Build Angular App'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'pm-platform-fe/dist/pm-platform-fe'
              artifact: 'angular-build'
              publishLocation: 'pipeline'
            displayName: 'Publish Angular Build Artifact'

  - stage: Deploy
    displayName: Deploy Angular
    dependsOn: Build
    jobs:
      - job: Deploy
        pool:
          name: 'Self-Hosted'
        steps:
          - script: dir pm-platform-fe/dist
            displayName: 'Check dist folder contents'

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'angular-build'
              path: '$(Pipeline.Workspace)/angular-build'
            displayName: 'Download Angular Build Artifact'

          - task: AzureWebApp@1
            inputs:
              azureSubscription: 'resourceManagerServiceConnection'
              appName: 'pmplatform'
              package: '$(Pipeline.Workspace)/angular-build'
            displayName: 'Deploy Angular App to Azure Web App'
